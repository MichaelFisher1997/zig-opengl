name: opencode

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  opencode:
    # Don't run on draft PRs; do run when they become ready_for_review.
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: blacksmith-2vcpu-ubuntu-2404
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=100
          git fetch origin ${{ github.event.pull_request.head.ref }} --depth=100
          git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} > /tmp/pr_diff.txt
          echo "Diff saved to /tmp/pr_diff.txt"

      - name: Fetch previous review comments
        id: previous-reviews
        uses: actions/github-script@v7
        with:
          script: |
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const comments = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const allComments = [];
            
            // Get comments from all reviews
            for (const review of reviews.data) {
              if (review.body) {
                allComments.push({
                  user: review.user.login,
                  body: review.body,
                  submitted_at: review.submitted_at
                });
              }
            }
            
            // Add inline review comments
            for (const comment of comments.data) {
              allComments.push({
                user: comment.user.login,
                body: comment.body,
                file: comment.path,
                line: comment.line,
                submitted_at: comment.created_at
              });
            }
            
            // Sort by date (oldest first)
            allComments.sort((a, b) => new Date(a.submitted_at) - new Date(b.submitted_at));
            
            // Format for output
            const formattedComments = allComments
              .filter(c => c.user.includes('bot') || c.user.includes('actions') || c.user.includes('opencode'))
              .map(c => `Review by ${c.user} at ${c.submitted_at}:\n${c.body}`)
              .join('\n\n---\n\n');
            
            require('fs').writeFileSync('/tmp/previous_reviews.txt', formattedComments || 'No previous automated reviews found.');
            console.log('Previous reviews saved to /tmp/previous_reviews.txt');

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16

      - name: Cache Nix Store
        uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.nix', 'flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-

      - name: Run opencode
        uses: anomalyco/opencode/github@latest
        env:
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        with:
          model: kimi-for-coding/k2p5
          prompt: |
            You are reviewing a pull request. The following files are available:
            - /tmp/pr_diff.txt: The current diff of this PR against the base branch
            - /tmp/previous_reviews.txt: Previous automated review comments on this PR

            First, read and analyze these files to understand:
            1. What changed in the current PR (/tmp/pr_diff.txt)
            2. What feedback was given in previous reviews (/tmp/previous_reviews.txt)

            Then perform your review and output it in the following STRICT STRUCTURE:

            ---

            ## ðŸ“‹ Summary
            2-3 sentences summarizing the PR purpose, scope, and overall quality.

            ## âœ… Resolved Issues
            List issues from previous_reviews.txt that have been fixed. Format:
            - **[RESOLVED]** ~File:Line - Brief description of what was fixed~ (strikethrough)
            - **[RESOLVED]** ~Another fixed issue~
            
            If no previous issues: "No previous issues to verify."

            ## ðŸ”´ Critical Issues (Must Fix - Blocks Merge)
            Only issues that could cause crashes, security vulnerabilities, data loss, or major bugs.
            
            For each issue, use this exact format:
            ```
            **[CRITICAL]** `File:Line` - Issue Title
            **Confidence:** High|Medium|Low (how sure you are this is a real problem)
            **Description:** Clear explanation of the issue
            **Impact:** What could go wrong if merged
            **Suggested Fix:** Specific code changes needed
            ```

            ## âš ï¸ High Priority Issues (Should Fix)
            Significant code quality issues, potential bugs, or architectural problems.
            
            Same format as Critical, but with **[HIGH]** prefix.

            ## ðŸ’¡ Medium Priority Issues (Nice to Fix)
            Style issues, minor optimizations, or code clarity improvements.
            
            Same format, with **[MEDIUM]** prefix.

            ## â„¹ï¸ Low Priority Suggestions (Optional)
            Minor suggestions, documentation improvements, or subjective preferences.
            
            Same format, with **[LOW]** prefix.

            ## ðŸ“Š SOLID Principles Score
            | Principle | Score | Notes |
            |-----------|-------|-------|
            | Single Responsibility | 0-10 | Brief justification |
            | Open/Closed | 0-10 | Brief justification |
            | Liskov Substitution | 0-10 | Brief justification |
            | Interface Segregation | 0-10 | Brief justification |
            | Dependency Inversion | 0-10 | Brief justification |
            | **Average** | **X.X** | |

            ## ðŸŽ¯ Final Assessment

            ### Overall Confidence Score: XX%
            Rate your confidence in this PR being ready to merge (0-100%).
            **How to interpret:**
            - 0-30%: Major concerns, do not merge without significant rework
            - 31-60%: Moderate concerns, several issues need addressing
            - 61-80%: Minor concerns, mostly ready with some fixes
            - 81-100%: High confidence, ready to merge or with trivial fixes

            ### Confidence Breakdown:
            - **Code Quality:** XX% (how well-written is the code?)
            - **Completeness:** XX% (does it fulfill requirements?)
            - **Risk Level:** XX% (how risky is this change?)
            - **Test Coverage:** XX% (are changes adequately tested?)

            ### Merge Readiness:
            - [ ] All critical issues resolved
            - [ ] SOLID average score >= 6.0
            - [ ] Overall confidence >= 60%
            - [ ] No security concerns
            - [ ] Tests present and passing (if applicable)

            ### Verdict:
            **MERGE** | **MERGE WITH FIXES** | **DO NOT MERGE**
            
            One-sentence explanation of the verdict.

            ---

            **Review Guidelines:**
            1. Only report issues that exist in pr_diff.txt (current code)
            2. Be extremely specific with file paths and line numbers
            3. For previous review items, mark as RESOLVED if fixed, or report again with current line numbers if still present
            4. Confidence scores should reflect how certain you are - use "Low" when unsure
            5. If you have nothing meaningful to add to a section, write "None identified" instead of omitting it
            6. Always provide actionable fixes, never just complaints

